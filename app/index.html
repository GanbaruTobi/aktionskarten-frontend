<!DOCTYPE html>
<html>
  <head>
    <title>Aktionskarten</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>

    <!-- Leaflet.Draw -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@0.4.12/dist/leaflet.draw.css" integrity="sha256-XzD3RpaHPv7lzX9qt+2n1j5cWj48O24KsgaGYpKN8x8=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet-draw@0.4.12/dist/leaflet.draw.js" integrity="sha256-gI2Y6ySMCz83g+AlqL24REslHKBuw73jaYfsZb5C3Ac=" crossorigin=""></script>

    <!-- Leaflet.StyleEditor -->
    <script src="https://dwilhelm89.github.io/Leaflet.StyleEditor/javascript/Leaflet.StyleEditor.min.js"></script>
    <link rel="stylesheet" href="https://dwilhelm89.github.io/Leaflet.StyleEditor/css/Leaflet.StyleEditor.min.css" />

    <!-- AktionskartenMarker -->
    <script src="https://kartographischeaktion.github.io/AktionskartenMarker/AktionskartenMarker.js"></script>
    <link rel="stylesheet" href="https://kartographischeaktion.github.io/AktionskartenMarker/AktionskartenMarker.css" />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

    <!-- Helper functions for HTTP-Request and other stuff -->
    <script src="utils.js"></script>

    <style>
      html, body, #map {
        width: 100%;
        height: 100%;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <div id='map'></div>

    <script>
      var map = L.map('map'),
          url ='https://maps.kombinat451.org/api/maps/1';

      // add Leaflet.StyleEditor
      var styleEditor = L.control.styleEditor({
        editLayers: [features],
        colorRamp: [
          '#e04f9e', '#fe0000', '#ee9c00', '#ffff00', '#00e13c', '#00a54c', '#00adf0', '#7e55fc', '#1f4199', '#7d3411'
        ],

        markerType: L.StyleEditor.marker.AktionskartenMarker,
        useGrouping: false // otherwise a change style applies to all
                           // auto-added featues
      });
      map.addControl(styleEditor);

      // Map features (editable through Leaflet.Draw and Leaflet.StyleEditor)
      // normally a FeatureGroup but GeoJSON extends FeatureGroup and populate
      // with geojson data. Custom methods need to be added here
      var FeatureLayer = L.GeoJSON.extend({
          addFeature(data) {
            var exists = false;
            this.eachLayer((layer) => {
              if (data.properties.id == layer.id) {
                exists = true;
              }
            })

            // already exists for client who created the feature
            if (!exists) {
              addData(data);
            }
          },
          updateFeature(data) {
            this.deleteFeature(data.properties.id);
            this.addData(data);
          },
          deleteFeature(id) {
            this.eachLayer((layer) => {
              if (id == layer.id) {
                this.removeLayer(layer);
              }
            })
          }
      });

      var features = new FeatureLayer(null, {
          // copies style and id to feature.options
          style: (f) => f.properties,
          pointToLayer: (feature, latlng) => {
            if (feature.properties.radius) {
              return L.circle(latlng,
                feature.properties.radius,
                feature.properties
              );
            }

            try {
              return L.marker(latlng, {icon: styleEditor.options.markerType.createMarkerIcon(feature.properties)});
            } catch (err) { console.log(err); }
            return L.marker(latlng);
          },
          onEachFeature: (feature, layer) => {
            layer.id = feature.properties.id;
            console.log('new feature', layer);
          } }).addTo(map);

      // add Leaflet.Draw
      map.addControl(new L.Control.Draw({
          edit: {
              featureGroup: features, // only allow features to be editable
          }
      }));


      // add Custom Control (for PDF export icon)
      var ExportControl = L.Control.extend({
        onAdd: function (map) {
          var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');

          container.style.backgroundColor = 'white';
          container.style.width = '30px';
          container.style.height = '30px';
          container.style.backgroundImage = "url(https://github.com/redbooth/free-file-icons/raw/master/32px/pdf.png)"; // License: MIT
          container.style.backgroundSize = "24px 24px";
          container.style.backgroundRepeat = "no-repeat";
          container.style.backgroundPosition = "center";

          container.onclick = function(){
            window.open(url+'/export/pdf');
          }

          return container;
        }
      });
      map.addControl(new ExportControl());

      // center map
      get(url).then(function(data) {
          var a = L.GeoJSON.coordsToLatLng(data.bbox.slice(0,2)),
              b = L.GeoJSON.coordsToLatLng(data.bbox.slice(2,4));
          map.fitBounds([a, b]);

          socket.emit('join', data.id);
        })

      // add tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        detectRetina: true,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
          '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a> '
      }).addTo(map);

      // add static grid
      get(url + '/grid').then(function(data) {
        L.geoJSON(data, {style: (f) => f.properties}).addTo(map);
      })

      // add features
      get(url + '/features').then(function(data) {
        features.addData(data);
      })


      //
      // events
      //
      map.on(L.Draw.Event.CREATED, function (e) {
        var geo = e.layer.toGeoJSON().geometry;
        geo.properties = getStyle(e.layer.options);

        if (geo.type == "Point") {
          // copy style (including icon)
          geo.properties = Object.assign(getStyle(e.options), geo.properties)

          // if the layer is a circle save radius to properties
          if (e.layer.getRadius){
            geo.properties.radius = e.layer.getRadius();
          }
        }

        post(url + '/features', geo)
          .then(function(data) {
            console.log("Added layer", data);
            e.layer.id = data.properties.id
            features.addData(data);
          })
      });

      map.on(L.Draw.Event.EDITED, function (e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
          var id = layer.options.id;
          put(url + '/features/' + id, layer.toGeoJSON().geometry)
            .then(function(data) {
              console.log("edited " + id);
          })
        });
      });

      map.on(L.Draw.Event.DELETED, function (e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
          console.log(layer)
          var id = layer.id;
          del(url + '/features/' + id, layer.toGeoJSON().geometry)
            .then(function(data) {
              console.log("deleted " + id);
          })
        });
      });

      map.on('styleeditor:changed', function(e){
        var style = getStyle(e.options);

        // dashArray="1" results in Leaflet as a straight line but in mapnik as
        // strokes. In mapnik to render a straight line, you don't provide any
        // dashArray. To have the same render result, delete it here.
        if ('dashArray' in style && style['dashArray'] == "1") {
          delete style['dashArray']
        }

        console.log(e, e.id)
        var id = e.id;
        patch(url + '/features/' + id, {'style': style})
          .then(function(data) {
            console.log("Changed style of " + id);
          })
      });

      //
      // Live changes from other clients
      //
      var socket = io.connect('http://localhost:5000');
      socket.on('connect', function() {
        console.log('connected')
      });
      socket.on('created', function(data) {
        console.log('event create', data);
        features.addFeature(data);
      });

      socket.on('updated', function(data) {
        console.log('event update', data);
        features.updateFeature(data);
      });

      socket.on('deleted', function(data) {
        console.log('event deleted', data);
        features.deleteFeature(data.properties.id);
      });
    </script>
  </body>
</html>
